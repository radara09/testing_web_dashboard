<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard AC RSUD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-baik { color: #16a34a; font-weight: bold; }
    .status-warning { color: #ca8a04; font-weight: bold; }
    .status-buruk { color: #dc2626; font-weight: bold; }

    /* üîπ Kartu kiri atas custom layout */
    .qr-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 220px; /* dikurangi supaya muat satu layar */
    }

    .qr-card img {
      width: 150px;
      height: 150px;
      margin-bottom: 1rem;
    }

    .qr-card p {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    @media (max-width: 768px) {
      .qr-card {
        min-height: 220px;
      }
      .qr-card img {
        width: 120px;
        height: 120px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <!-- Overlay spinner for initial load -->
  <div id="initialOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="text-center">
      <svg class="animate-spin h-12 w-12 text-gray-700 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="mt-3 text-gray-700 font-medium">Memuat dashboard...</p>
    </div>
  </div>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- üîπ KIRI ATAS (Dashboard Ringkas now here) -->
    <div class="bg-white rounded-3xl shadow p-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-700">Dashboard Ringkas</h2>
        <button id="refreshBtn" onclick="loadDashboard()"
                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm transition flex items-center gap-2">
          <svg id="refreshSpinner" class="hidden animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span id="refreshText">üîÑ Refresh Sekarang</span>
        </button>
      </div>

      <!-- ÔøΩ 3 Kartu Interaktif -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <!-- AC Bermasalah -->
        <div onclick="showList('bermasalah')" 
             class="cursor-pointer bg-red-50 hover:bg-red-100 p-4 rounded-2xl text-center shadow-md transition-all transform hover:scale-105">
          <p class="text-sm text-gray-600 mb-1">AC Bermasalah</p>
          <h2 id="card_acBermasalah" class="text-3xl font-bold text-red-500">0</h2>
        </div>

        <!-- Belum Diservice >3 Bulan -->
        <div onclick="showList('belumdiservice')" 
             class="cursor-pointer bg-yellow-50 hover:bg-yellow-100 p-4 rounded-2xl text-center shadow-md transition-all transform hover:scale-105">
          <p class="text-sm text-gray-600 mb-1">Belum Diservice &gt;3 Bulan</p>
          <h2 id="card_belumDiservice" class="text-3xl font-bold text-yellow-500">0</h2>
        </div>

        <!-- Jumlah Teknisi -->
        <div onclick="showList('teknisi')" 
             class="cursor-pointer bg-blue-50 hover:bg-blue-100 p-4 rounded-2xl text-center shadow-md transition-all transform hover:scale-105">
          <p class="text-sm text-gray-600 mb-1">Jumlah Teknisi</p>
          <h2 id="card_totalTeknisi" class="text-3xl font-bold text-blue-500">0</h2>
        </div>
      </div>

      <!-- üîπ Total AC di bawah (optional, tetap bisa kamu hapus) -->
      <div class="mt-4 bg-green-100 p-4 rounded-2xl text-center shadow-inner">
        <p class="text-sm text-gray-700">Total AC</p>
        <h2 id="totalAC" class="text-2xl font-bold text-green-900">0</h2>
      </div>
      <p class="text-xs text-gray-400 mt-2 text-center" id="lastUpdate">Terakhir update: -</p>
    </div>

    <!-- üîπ KIRI BAWAH (QR Card moved here) -->
  <div class="bg-white rounded-3xl shadow p-4 qr-card">
      <a id="qrLink" href="#" target="_blank" rel="noopener">
        <img id="qrImage"
          src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=AC-RS1-001"
          alt="QR Code">
      </a>
      <p id="qrText">AC-RS1-001</p>
    </div>

    <!-- üîπ KANAN ATAS (Form Maintenance moved here) -->
  <div class="bg-white rounded-3xl shadow p-4">
      <h2 class="text-lg font-bold mb-3">Form Maintenance AC RSUD</h2>
      <label for="idInput" class="block mb-2">Cari ID_AC</label>
      <div class="flex gap-2 mb-4 items-center">
        <input id="idInput" type="text" placeholder="AC-RS1-001"
          class="border p-2 rounded w-full focus:ring focus:ring-blue-300">
        <button id="cariBtn" onclick="cariAC()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2">
          <span id="cariBtnText">Cari</span>
          <svg id="searchSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-1 text-gray-700">
        <p><b>Tekanan Freon:</b> <span id="tekananFreon">-</span></p>
        <p><b>Suhu Keluar:</b> <span id="suhuKeluar">-</span></p>
        <p><b>Ampere Kompresor:</b> <span id="ampereKompresor">-</span></p>
        <p><b>Kondisi Filter:</b> <span id="kondisiFilter">-</span></p>
      </div>
    </div>

    <!-- üîπ KANAN BAWAH (Informasi Detail moved here) -->
  <div class="bg-white rounded-3xl shadow p-4">
      <h2 class="text-xl font-bold mb-4">Informasi Detail AC</h2>
      <div class="space-y-1 text-gray-700">
        <p><b>Kode AC:</b> <span id="kodeAC">-</span></p>
        <p><b>Lokasi:</b> <span id="lokasiAC">-</span></p>
        <p><b>Merek:</b> <span id="merekAC">-</span></p>
        <p><b>Kondisi Terakhir:</b> <span id="kondisiAC" class="status-baik">-</span></p>
        <p><b>Service Terakhir:</b> <span id="serviceTerakhir">-</span></p>
        <p><b>Teknisi:</b> <span id="teknisiAC">-</span></p>
        <p><b>Jadwal Berikut:</b> <span id="jadwalBerikut">-</span></p>
      </div>
      <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-xl">
        Lihat Foto Terakhir
      </button>
    </div>


      <!-- üîπ Popup Modal -->
      <div id="popupModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg max-w-3xl w-full p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 id="popupTitle" class="text-lg font-bold">Daftar</h3>
            <button onclick="closePopup()" class="text-gray-600 hover:text-gray-900">Tutup ‚úñ</button>
          </div>
          <div id="popupContent" class="text-sm text-gray-700 max-h-80 overflow-auto">
                <!-- konten diisi oleh showList() -->
              </div>
            </div>
          </div>
        </div>

  </div>

  <script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxNxMqgNAgYQ6lDoVpztmYM4wcc-DrnWkKXT9pJqzfN0jSDeplyzsiMoUBhxN2oZ7dc/exec'; // Ganti dgn URL Web App kamu

  // üü¢ Load ringkasan dashboard
  async function loadDashboard() {
    const btn = document.getElementById('refreshBtn');
    const spinner = document.getElementById('refreshSpinner');
    const text = document.getElementById('refreshText');
    // show loading state
    btn.disabled = true;
    spinner.classList.remove('hidden');
    text.innerText = 'Memuat...';
    try {
      const res = await fetch(SCRIPT_URL);
      const result = await res.json();

      // Cegah error kalau struktur JSON beda
      const summary = result.summary
        ? result.summary
        : { totalAC: 0, bermasalah: 0, belumDiservice: 0, totalTeknisi: 0 };

      // Update 4 angka utama
      document.getElementById("totalAC").innerText = summary.totalAC;
      document.getElementById("card_acBermasalah").innerText = summary.bermasalah;
      document.getElementById("card_belumDiservice").innerText = summary.belumDiservice;
      document.getElementById("card_totalTeknisi").innerText = summary.totalTeknisi;

      const now = new Date();
      document.getElementById("lastUpdate").innerText =
        "Terakhir update: " + now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    } catch (err) {
      console.error("Dashboard error:", err);
      alert("‚ö†Ô∏è Gagal memuat data dashboard!");
    } finally {
      // restore button
      btn.disabled = false;
      spinner.classList.add('hidden');
      text.innerText = 'üîÑ Refresh Sekarang';
    }
  }

  // üü¢ Tampilkan daftar saat kartu diklik
  async function showList(type) {
    try {
      document.getElementById('popupTitle').innerText = 'Memuat...';
      document.getElementById('popupContent').innerHTML = `<p class="text-sm text-gray-500">Loading...</p>`;
      document.getElementById('popupModal').classList.remove('hidden');

      const res = await fetch(`${SCRIPT_URL}?type=${type}`);
      const result = await res.json();

      document.getElementById('popupTitle').innerText = result.title || 'Daftar';
      let html = '';

      if (result.list && result.list.length) {
        const first = result.list[0];
        if (typeof first === 'object' && !Array.isArray(first)) {
          const headers = Object.keys(first);
          html += `<div class="overflow-x-auto"><table class="min-w-full text-sm text-left"><thead class="bg-gray-100"><tr>`;
          headers.forEach(h => html += `<th class="p-2 font-medium">${h}</th>`);
          html += `</tr></thead><tbody>`;
          result.list.forEach(row => {
            html += `<tr class="border-b">`;
            headers.forEach(h => html += `<td class="p-2">${row[h] ?? '-'}</td>`);
            html += `</tr>`;
          });
          html += `</tbody></table></div>`;
        } else {
          html += `<ul class="list-disc pl-5">`;
          result.list.forEach(item => html += `<li>${item}</li>`);
          html += `</ul>`;
        }
      } else {
        html = `<p class="text-gray-600">Tidak ada data.</p>`;
      }

      document.getElementById('popupContent').innerHTML = html;
    } catch (err) {
      console.error('showList error:', err);
      document.getElementById('popupTitle').innerText = 'Terjadi kesalahan';
      document.getElementById('popupContent').innerHTML =
        `<p class="text-sm text-red-600">Gagal memuat data. Cek koneksi atau coba lagi nanti.</p>`;
    }
  }

  function closePopup() {
    document.getElementById('popupModal').classList.add('hidden');
    document.getElementById('popupContent').innerHTML = '';
  }

  // üîπ Format tanggal ISO ke format Indonesia yang rapi
  function formatTanggal(tanggal) {
    if (!tanggal) return "-";
    const d = new Date(tanggal);
    if (isNaN(d)) return tanggal; // kalau bukan format valid
    return d.toLocaleString("id-ID", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    //   hour: "2-digit",
    //   minute: "2-digit"
    });
  }

  

  // üü¢ Pencarian AC berdasarkan ID
  async function cariAC() {
    const id = document.getElementById("idInput").value.trim();
    if (!id) return alert("Masukkan ID_AC terlebih dahulu!");
    const inputEl = document.getElementById('idInput');
    const btn = document.getElementById('cariBtn');
    const spinner = document.getElementById('searchSpinner');

    // disable while loading
    inputEl.disabled = true;
    btn.disabled = true;
    spinner.classList.remove('hidden');

    try {
      const res = await fetch(`${SCRIPT_URL}?id=${id}`);
      const ac = await res.json();

      if (!ac || !ac.ID_AC) {
        clearACInfo();
        return alert("Data tidak ditemukan!");
      }

      // Isi data utama
      document.getElementById("kodeAC").innerText = ac.ID_AC || '-';
      document.getElementById("lokasiAC").innerText = ac.Lokasi || '-';
      document.getElementById("merekAC").innerText = ac.Merek || '-';

      // Warna kondisi
      const kondisi = (ac["Kondisi Terakhir"] || "-").toLowerCase();
      const elKondisi = document.getElementById("kondisiAC");
      elKondisi.innerText = ac["Kondisi Terakhir"] || '-';
      elKondisi.className =
        kondisi.includes('buruk') || kondisi.includes('rusak')
          ? 'status-buruk'
          : kondisi.includes('perlu')
            ? 'status-warning'
            : 'status-baik';

      // Format tanggal & waktu
      document.getElementById("serviceTerakhir").innerText = formatTanggal(ac["Service Terakhir"]);
      document.getElementById("jadwalBerikut").innerText = formatTanggal(ac["Jadwal Berikut"]);

      // Data tambahan
      document.getElementById("teknisiAC").innerText = ac.Teknisi || '-';
      document.getElementById("tekananFreon").innerText = ac["Tekanan Freon"] || '-';
      document.getElementById("suhuKeluar").innerText = ac["Suhu Keluar"] || '-';
      document.getElementById("ampereKompresor").innerText = ac["Ampere Kompresor"] || '-';
      document.getElementById("kondisiFilter").innerText = ac["Kondisi Filter"] || '-';

      // Update QR (image + link)
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?id=' + id)}`;
      document.getElementById("qrImage").src = qrUrl;
      document.getElementById("qrText").innerText = id;
      const qrLink = document.getElementById('qrLink');
      if (qrLink) {
        qrLink.href = window.location.origin + window.location.pathname + '?id=' + encodeURIComponent(id);
      }

    } catch (err) {
      console.error("CariAC error:", err);
      clearACInfo();
      alert("‚ö†Ô∏è Gagal mencari data!");
    } finally {
      // re-enable
      inputEl.disabled = false;
      btn.disabled = false;
      spinner.classList.add('hidden');
    }
  }

  // Helper: kosongkan semua field detail AC
  function clearACInfo() {
    const fields = [
      'kodeAC', 'lokasiAC', 'merekAC', 'kondisiAC', 'serviceTerakhir',
      'jadwalBerikut', 'teknisiAC', 'tekananFreon', 'suhuKeluar',
      'ampereKompresor', 'kondisiFilter', 'qrImage', 'qrText'
    ];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (id === 'qrImage') {
        el.src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=';
      } else if (id === 'qrText') {
        el.innerText = '-';
      } else {
        el.innerText = '-';
      }
    });
    // reset qr link too
    const qrLinkEl = document.getElementById('qrLink');
    if (qrLinkEl) qrLinkEl.href = '#';
  }
  
  // üîπ Jalankan pencarian saat tekan Enter di input ID_AC
  document.getElementById("idInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault(); // biar gak reload halaman
      cariAC();
    }
  });

  // Wrapper untuk initial load dengan overlay
  async function initialLoad() {
    const overlay = document.getElementById('initialOverlay');
    overlay.classList.remove('hidden');
    try {
      await loadDashboard();
      // Jika URL memiliki parameter id, isi input dan jalankan cariAC
      const params = new URLSearchParams(window.location.search);
      const idParam = params.get('id');
      if (idParam) {
        const input = document.getElementById('idInput');
        if (input) input.value = idParam;
        // jalankan cariAC dan tunggu selesai
        await cariAC();
      }
      setInterval(loadDashboard, 300000);
    } finally {
      overlay.classList.add('hidden');
    }
  }

  // Jalankan initial load saat halaman dibuka
  window.onload = () => {
    initialLoad();
  };


</script>
</body>
</html>
